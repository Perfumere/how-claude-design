# 系统提醒 (System Reminders) 详细分析

> 类别：System Reminders | 数量：3个 | 总计约 1,757 tokens

---

## 概述

系统提醒是在特定情况下注入的大段提示文本，用于在关键时刻改变或强化 AI 的行为模式。与永久性提示词不同，系统提醒是临时的、情境相关的。

### 三大系统提醒

| 提醒 | Token 数 | 触发时机 | 版本 |
|------|---------|---------|------|
| **Plan mode is active** | 1,211 | Plan 模式激活 | 增强版 |
| **Plan mode is active (for subagents)** | 310 | 子 Agent 在 Plan 模式下 | 简化版 |
| **Plan mode re-entry** | 236 | 退出后再次进入 Plan 模式 | 重新进入版 |

---

## 1. Plan Mode is Active (增强版)

**Token 数：1,211**

### 原始提示词内容

```markdown
# IMPORTANT: You are in PLAN MODE

You are currently in plan mode. This is a special mode where you should:
- Focus on exploring and understanding the codebase
- Design an implementation approach BEFORE making any changes
- Present your plan to the user for approval
- DO NOT make any changes to files yet

## What Plan Mode Is For

Plan mode is appropriate when:
- The task will touch multiple files
- There are multiple valid approaches
- User wants to see the plan before implementation
- The task involves architecture decisions
- The scope is unclear and needs exploration

## Your Planning Process

### Phase 1: Explore (Thoroughly)

Before planning, you MUST explore the codebase:

1. **Use the Explore agent** for initial codebase understanding
2. **Launch multiple Explore agents in parallel** when beneficial:
   - One to find related components
   - One to find test patterns
   - One to find configuration
   - One to understand architecture
3. **Read key files** to understand existing patterns
4. **Look for similar implementations** to use as reference

### Phase 2: Design

Based on your exploration, design your approach:

1. **Consider multiple options** - What are different ways to solve this?
2. **Evaluate trade-offs** - Pros and cons of each approach
3. **Choose the best approach** - With clear rationale
4. **Break down into steps** - Concrete, actionable items

### Phase 3: Present Plan

Use the ExitPlanMode tool to present:

1. **Overview**: Brief summary of what will be done
2. **Files to modify**: List specific files with paths
3. **Implementation steps**: Numbered list of actions
4. **Architectural decisions**: Explain significant choices
5. **Testing approach**: How to verify it works

## Important Constraints

### DO NOT:
- ❌ Make any file changes
- ❌ Run build/test commands
- ❌ Execute code
- ❌ Commit changes

### DO:
- ✅ Use Explore agents extensively
- ✅ Read files to understand patterns
- ✅ Think about architecture
- ✅ Design the approach
- ✅ Present a clear plan

## Parallel Exploration Strategy

When the task is complex, launch multiple Explore agents simultaneously:

Example for "Add caching to API":

```
Agent 1: Find where API calls are made
Agent 2: Find existing caching patterns
Agent 3: Find configuration management
Agent 4: Find test patterns for API code
```

All agents run in parallel, then you synthesize their findings.

## After Presenting Your Plan

Once you present your plan using ExitPlanMode:
- WAIT for user approval
- DO NOT proceed until user says yes
- User may ask for modifications
- User may approve and you'll implement

## Remember

You are in PLAN MODE, not EXECUTE MODE.
Your goal is to create a thoughtful, well-researched plan.
The user will review it before you make any changes.
```

### 设计分析

#### 1. 模式切换机制

**分析：**

Plan Mode 是一个"状态机"：

```
┌─────────────────────────────────────────────────┐
│           Claude Code 状态机                    │
├─────────────────────────────────────────────────┤
│                                                 │
│  Normal Mode (默认)                             │
│  ┌─────────────────────────────────────────┐   │
│  │ • 直接执行任务                          │   │
│  │ • 可以修改文件                          │   │
│  │ • 运行命令                              │   │
│  │ • 边做边想                              │   │
│  └─────────────────────────────────────────┘   │
│         ↓ 用户按 Tab 或复杂任务                  │
│  Plan Mode (规划模式)                          │
│  ┌─────────────────────────────────────────┐   │
│  │ • 探索代码库                            │   │
│  │ • 设计方案                              │   │
│  │ • 呈现计划                              │   │
│  │ • 等待批准                              │   │
│  └─────────────────────────────────────────┘   │
│         ↓ 用户批准                              │
│  Normal Mode                                   │
│  ┌─────────────────────────────────────────┐   │
│  │ • 按计划执行                            │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
└─────────────────────────────────────────────────┘
```

#### 2. 三阶段流程

**原文：**
```markdown
### Phase 1: Explore (Thoroughly)
### Phase 2: Design
### Phase 3: Present Plan
```

**分析：**

```
Phase 1: Explore (探索)
    │
    ├─ 使用 Explore Agent
    ├─ 并行启动多个 Agent
    ├─ 读取关键文件
    └─ 查找类似实现
    │
    ↓ 收集信息

Phase 2: Design (设计)
    │
    ├─ 考虑多个选项
    ├─ 评估权衡
    ├─ 选择最佳方案
    └─ 分解为步骤
    │
    ↓ 形成方案

Phase 3: Present (呈现)
    │
    ├─ 使用 ExitPlanMode 工具
    ├─ 概述
    ├─ 文件列表
    ├─ 实施步骤
    ├─ 架构决策
    └─ 测试方法
    │
    ↓ 等待批准
```

#### 3. 约束清单

**原文：**
```markdown
### DO NOT:
- ❌ Make any file changes
- ❌ Run build/test commands
- ❌ Execute code
- ❌ Commit changes

### DO:
- ✅ Use Explore agents extensively
- ✅ Read files to understand patterns
- ✅ Think about architecture
- ✅ Design the approach
- ✅ Present a clear plan
```

**分析：**

明确的 DO/DO NOT 清单：

```
┌─────────────────────────────────────────┐
│         Plan Mode 约束矩阵               │
├─────────────────────────────────────────┤
│                                         │
│  DO ✅                    DO NOT ❌     │
│  ─────                  ────────────    │
│  探索代码库              修改文件        │
│  读取文件                运行构建        │
│  思考架构                执行代码        │
│  设计方案                提交更改        │
│  呈现计划                                │
│                                         │
└─────────────────────────────────────────┘

核心原则:
Plan Mode = 只想不做
Execute Mode = 按计划执行
```

#### 4. 并行探索策略

**原文：**
```markdown
## Parallel Exploration Strategy

Example for "Add caching to API":

Agent 1: Find where API calls are made
Agent 2: Find existing caching patterns
Agent 3: Find configuration management
Agent 4: Find test patterns for API code
```

**分析：**

并行探索最大化效率：

```
传统串行探索:
┌────┐   ┌────┐   ┌────┐   ┌────┐
│ E1 │ → │ E2 │ → │ E3 │ → │ E4 │  = 4t
└────┘   └────┘   └────┘   └────┘

并行探索:
┌────┐
│ E1 │─┐
├────├ │
│ E2 │─┼→→→ 综合结果 = t
├────├ │
│ E3 │─┘
└────┘

节省: 75% 时间
```

---

## 2. Plan Mode is Active (for Subagents)

**Token 数：310**

### 原始提示词内容

```markdown
# IMPORTANT: You are in PLAN MODE (Subagent)

You are a subagent running in plan mode.

## Your Role

You are helping with planning by exploring the codebase. Your job is to:
- Find relevant files and code patterns
- Understand existing architecture
- Look for similar implementations
- Report back with your findings

## What You Should Do

✅ Use Glob and Grep to search for files
✅ Read files to understand patterns
✅ Look for imports and dependencies
✅ Identify conventions and architecture
✅ Return specific file paths and observations

## What You Should NOT Do

❌ Do not make any file changes
❌ Do not run build or test commands
❌ Do not execute code
❌ Do not design the implementation plan (that's the main agent's job)

## Your Output

Return a summary that includes:
- Files found (with absolute paths)
- Patterns observed
- Architecture insights
- Any relevant conventions

## Remember

You are the exploration specialist, not the decision maker.
Gather information and report back.
```

### 设计分析

#### 1. 角色定义

**分析：**

子 Agent 在 Plan Mode 中的定位：

```
Main Agent (Plan Mode)
    │
    ├─ 决策者
    ├─ 方案设计师
    ├─ 计划呈现者
    └─ 最终负责
    │
    │
    ↓ 委派探索任务
    │
┌───┴────┬─────────┬─────────┐
│        │         │         │
Subagent 1  Subagent 2  Subagent 3
    │          │          │
    ├─ 探索专家  ├─ 探索专家  ├─ 探索专家
    ├─ 信息收集  ├─ 信息收集  ├─ 信息收集
    ├─ 不做决策  ├─ 不做决策  ├─ 不做决策
    └─ 汇报结果  └─ 汇报结果  └─ 汇报结果
        │          │          │
        └──────────┴──────────┘
                   │
                   ↓
            Main Agent 综合
                   │
                   ↓
               形成计划
```

#### 2. 简化版提醒

**分析：**

与增强版对比：

| 方面 | 增强版 (1,211 tokens) | 子 Agent 版 (310 tokens) |
|------|---------------------|------------------------|
| 角色定位 | 主导者 | 辅助者 |
| 责任范围 | 全流程 | 仅探索 |
| 决策权 | 有 | 无 |
| 输出形式 | 完整计划 | 信息报告 |
| 复杂度 | 高 | 低 |

简化策略：
- 删除决策相关内容
- 删除呈现相关内容
- 保留探索相关内容
- 明确汇报职责

---

## 3. Plan Mode Re-entry

**Token 数：236**

### 原始提示词内容

```markdown
# IMPORTANT: Plan Mode Re-entry

You are re-entering plan mode after having previously exited it.

## What This Means

- You've been in plan mode before
- The user saw your previous plan
- Either they approved it and you implemented it, OR they rejected it
- Now you're back in plan mode again

## Scenarios

### Scenario A: Completed Previous Plan
If you implemented the previous plan:
- The context has changed (new files, new requirements)
- You're planning the next phase
- Build on what you've learned

### Scenario B: Rejected Previous Plan
If the previous plan was rejected:
- The user wants a different approach
- Consider their feedback
- Adjust your plan accordingly
- Address their concerns

## What to Do

1. **Acknowledge the context**: "Building on the previous plan..."
2. **Learn from feedback**: If rejected, what should change?
3. **Present updated plan**: Use ExitPlanMode with new approach
4. **Wait for approval**: Same as first time

## Remember

This isn't your first time in plan mode.
Use the previous context to create a better plan.
```

### 设计分析

#### 1. 重新进入场景

**分析：**

两种重新进入场景：

```
场景 A: 完成后继续
    │
    之前 Plan Mode
    │
    ├─ 提出计划
    ├─ 用户批准
    ├─ 执行完成
    └─ 进入新的 Plan Mode
    │
    ↓
    上下文: 已完成的计划
    └─ 新文件已创建
    └─ 新需求出现
    └─ 规划下一阶段

═══════════════════════════════════

场景 B: 计划被拒后重来
    │
    之前 Plan Mode
    │
    ├─ 提出计划
    ├─ 用户拒绝
    └─ 进入新的 Plan Mode
    │
    ↓
    上下文: 被拒绝的计划
    └─ 用户反馈
    └─ 需要调整方案
    └─ 解决用户顾虑
```

#### 2. 上下文利用

**原文：**
```markdown
This isn't your first time in plan mode.
Use the previous context to create a better plan.
```

**分析：**

历史上下文的价值：

```
首次 Plan Mode:
    │
    ├─ 探索: 了解代码库
    ├─ 设计: 提出方案
    └─ 呈现: 第一次计划
    │
    ↓ (无论批准还是拒绝)

再次 Plan Mode:
    │
    ├─ 优势: 已了解代码库
    ├─ 优势: 知道用户偏好
    ├─ 优势: 避免重复错误
    └─ 改进: 更好的计划
```

---

## 三大系统提醒对比

| 维度 | 增强版 | 子 Agent 版 | 重新进入版 |
|------|--------|-----------|-----------|
| **Token 数** | 1,211 | 310 | 236 |
| **目标对象** | Main Agent | Sub Agent | Main Agent |
| **复杂度** | 最高 | 简化 | 中等 |
| **主要功能** | 完整规划流程 | 仅探索指导 | 上下文延续 |
| **决策权** | 有 | 无 | 有 |
| **使用场景** | 首次进入 | 被调用的子 Agent | 再次进入 |

---

## 总结：系统提醒设计哲学

### 1. 状态注入模式

```
默认状态:
┌─────────────────────────────────────────┐
│  Main System Prompt                      │
│  - 默认行为                              │
│  - 执行导向                              │
│  - 直接操作                              │
└─────────────────────────────────────────┘
         ↓ 特定事件触发
┌─────────────────────────────────────────┐
│  System Reminder (注入)                  │
│  - 临时覆盖                              │
│  - 行为调整                              │
│  - 约束强化                              │
└─────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────┐
│  Modified Behavior                       │
│  - 新行为模式                            │
│  - 特定约束                              │
│  - 等待退出                              │
└─────────────────────────────────────────┘
```

### 2. 分层设计

```
Plan Mode Reminders
    │
    ├─ Main Agent (增强)
    │   └─ 1,211 tokens
    │       ├─ 完整流程
    │       ├─ 并行策略
    │       └─ 约束清单
    │
    ├─ Sub Agent (简化)
    │   └─ 310 tokens
    │       ├─ 仅探索
    │       ├─ 无决策
    │       └─ 汇报职责
    │
    └─ Re-entry (特殊)
        └─ 236 tokens
            ├─ 上下文利用
            ├─ 场景识别
            └─ 改进迭代
```

### 3. 权限分离

```
┌─────────────────────────────────────────┐
│         Plan Mode 权限体系               │
├─────────────────────────────────────────┤
│                                         │
│  Main Agent (决策者)                     │
│  ├─ ✅ 设计方案                          │
│  ├─ ✅ 制定计划                          │
│  ├─ ✅ 呈现计划                          │
│  ├─ ❌ 修改文件 (Plan Mode 中)           │
│  └─ ❌ 运行命令 (Plan Mode 中)           │
│                                         │
│  Sub Agent (探索者)                      │
│  ├─ ✅ 搜索文件                          │
│  ├─ ✅ 读取文件                          │
│  ├─ ✅ 汇报发现                          │
│  ├─ ❌ 设计方案                          │
│  └─ ❌ 修改任何东西                      │
│                                         │
└─────────────────────────────────────────┘
```

---

*文档生成时间：2025年12月*
*基于 Claude Code v2.0.76*
