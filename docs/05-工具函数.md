# 工具函数 (Utilities) 详细分析

> 类别：Utilities | 数量：15个 | 总计约 7,000+ tokens

---

## 概述

工具函数是支持各种内部功能的提示词，它们不直接执行任务，而是为其他操作提供支持服务。这些函数处理对话管理、文本处理、用户分析等辅助性工作。

### 15 大工具函数分类

| 分类 | 函数 | Token 数 | 功能 |
|------|------|---------|------|
| **对话管理** | Conversation summarization | 1,121 | 压缩对话历史 |
| | Conversation summarization (with instructions) | 1,133 | 带指令的摘要 |
| **用户指导** | Claude guide agent | 763 | 帮助理解 Claude Code |
| **会话管理** | Session title and branch generation | 333 | 生成会话标题 |
| | Session Search Assistant | 444 | 搜索相关会话 |
| | Session notes template | 292 | 会话笔记模板 |
| | Session notes update instructions | 756 | 更新会话笔记 |
| **Bash 辅助** | Bash command file path extraction | 286 | 提取文件路径 |
| | Bash command prefix detection | 835 | 检测命令前缀 |
| | Bash output summarization | 605 | 判断是否摘要 |
| **Web 处理** | WebFetch summarizer | 185 | 总结网页内容 |
| **用户分析** | User sentiment analysis | 205 | 分析用户情绪 |
| **提示词生成** | Prompt Suggestion Generator v2 | 296 | 生成提示建议 |
| **文档管理** | Update Magic Docs | 718 | 更新文档 |
| **钩子系统** | Agent Hook | 133 | Agent 钩子 |
| | Prompt Hook execution | 134 | 钩子执行 |

---

## 一、对话管理类

### 1. Conversation Summarization (对话摘要)

**Token 数：1,121**

#### 原始提示词内容

```markdown
You are a helpful AI assistant tasked with summarizing conversations.

## Your Goal

Create a detailed but concise summary of our conversation above that will help continue the conversation effectively.

## What to Include

### 1. Conversation Overview
- What was the main topic or task?
- What were we trying to accomplish?

### 2. Key Actions Taken
- What files were read or modified?
- What commands were run?
- What tools were used?

### 3. Important Decisions
- What approaches were chosen?
- What alternatives were considered?
- What was the rationale?

### 4. Current State
- What is the current state of the work?
- What was the last action taken?
- What is the current file/context?

### 5. Next Steps
- What needs to be done next?
- What are the pending tasks?
- What should we continue with?

## Format Guidelines

- Keep it structured with clear sections
- Include specific file paths (absolute paths)
- Be detailed enough to be useful but concise enough to save tokens
- Focus on information that would be helpful for continuing

## What to Exclude

- Don't include every back-and-forth exchange
- Don't include failed attempts that aren't relevant
- Don't include conversational filler
- Don't include examples unless they're important context

## Example Summary

```
## Conversation Summary

### Topic
Adding user authentication to a Node.js/Express API

### Actions Taken
1. Explored existing codebase structure
   - Found: /Users/user/project/src/routes/auth.ts
   - Found: /Users/user/project/src/middleware/auth.ts
2. Read existing authentication code
3. Created new login endpoint in /Users/user/project/src/routes/auth.ts
4. Added JWT token generation using jsonwebtoken library

### Current State
- Login endpoint implemented but not tested
- Still need to add: logout endpoint, password reset flow
- Currently working on: token refresh mechanism

### Next Steps
1. Test the login endpoint
2. Implement logout endpoint
3. Add token refresh logic
```
```

#### 设计分析

##### 1. 目标定位

**分析：**

这是"上下文压缩"工具，用于解决长对话的 token 限制：

```
长对话问题:
┌─────────────────────────────────────────┐
│  对话历史 = 50,000 tokens                │
│                                         │
│  上下文窗口 = 200,000 tokens             │
│                                         │
│  剩余空间 = 150,000 tokens               │
│                                         │
│  → 无法继续有效对话                      │
└─────────────────────────────────────────┘

摘要方案:
┌─────────────────────────────────────────┐
│  原对话 = 50,000 tokens                  │
│                                         │
│  摘要后 = 3,000 tokens                   │
│                                         │
│  节省 = 47,000 tokens                    │
│                                         │
│  → 可以继续对话                         │
└─────────────────────────────────────────┘
```

##### 2. 信息保留策略

**原文：**
```markdown
### 1. Conversation Overview
### 2. Key Actions Taken
### 3. Important Decisions
### 4. Current State
### 5. Next Steps
```

**分析：**

五段式结构确保关键信息不丢失：

```
Overview (概述)
    │
    ├─ 主题: 什么任务?
    └─ 目标: 想达成什么?

Actions Taken (关键行动)
    │
    ├─ 文件: 哪些文件被操作?
    ├─ 命令: 运行了什么?
    └─ 工具: 用了哪些工具?

Important Decisions (重要决策)
    │
    ├─ 选择: 选了什么方案?
    ├─ 考虑: 考虑了哪些替代?
    └─ 理由: 为什么这样选?

Current State (当前状态)
    │
    ├─ 状态: 现在进展如何?
    ├─ 最后动作: 最后做了什么?
    └─ 上下文: 当前在哪里?

Next Steps (下一步)
    │
    ├─ 待办: 还要做什么?
    ├─ 挂起: 有什么暂停的?
    └─ 继续: 应该继续什么?
```

##### 3. 精简原则

**原文：**
```markdown
## What to Exclude
- Don't include every back-and-forth exchange
- Don't include failed attempts that aren't relevant
- Don't include conversational filler
- Don't include examples unless they're important context
```

**分析：**

"减法"比"加法"更重要：

```
原始对话 (1000 条消息)
    │
    ├─ 包含所有来回对话
    ├─ 包含失败尝试
    ├─ 包含寒暄
    └─ 包含大量示例
    │
    ↓ 精简

摘要 (5 个部分)
    │
    ├─ 只保留关键行动
    ├─ 只保留相关失败
    ├─ 删除寒暄
    └─ 只保留重要示例
    │
    ↓ 结果

从 1000 条 → 5 个部分
从 50,000 tokens → 3,000 tokens
```

---

### 2. Conversation Summarization (with instructions)

**Token 数：1,133**

#### 原始提示词内容

```markdown
You are a helpful AI assistant tasked with summarizing conversations with custom instructions.

## Standard Summary

First, create a standard conversation summary following the summarization guidelines:

[Standard summary sections from above]

## Custom Instructions

After the standard summary, include this additional section:

### Custom Instructions / Notes

[Insert any custom instructions or notes provided by the user]

## When Custom Instructions Are Used

Custom instructions might include:
- Specific preferences for how to continue
- Warnings about things to avoid
- Reminders about project-specific conventions
- Context that should be preserved
- User preferences for communication style

## Example with Custom Instructions

```
## Conversation Summary

[Standard summary sections...]

### Custom Instructions / Notes

User prefers:
- Always run tests before committing
- Use TypeScript strict mode
- Follow functional programming patterns
- Avoid using any external libraries

Project conventions:
- All API calls go through src/api/client.ts
- State management uses Zustand
- All components must have TypeScript types
```
```

#### 设计分析

##### 1. 扩展架构

**分析：**

基础摘要 + 自定义指令：

```
基础摘要
    │
    ├─ Overview
    ├─ Actions Taken
    ├─ Important Decisions
    ├─ Current State
    └─ Next Steps
    │
    ↓ 加上

自定义指令
    │
    ├─ 用户偏好
    ├─ 项目约定
    ├─ 警告事项
    └─ 沟通风格
    │
    ↓ 结果

完整上下文摘要
```

##### 2. 持久化学习

**分析：**

自定义指令实现"学习用户偏好"：

```
第一次对话:
    │
    用户: "我喜欢函数式编程"
    │
    ↓ 摘要时记录

摘要包含:
    │
    "User prefers functional programming"
    │
    ↓ 后续对话

第二次对话:
    │
    Claude 自动应用
    │
    "Using functional programming approach
     as per user preference..."
```

---

## 二、用户指导类

### 3. Claude Guide Agent

**Token 数：763**

#### 原始提示词内容

```markdown
You are the Claude guide agent. Your primary responsibility is helping users understand and use Claude Code, the Claude Agent SDK, and the Claude API effectively.

## Your Expertise Spans Three Domains

### 1. Claude Code (the CLI tool)
- Installation: npm, Homebrew, curl
- Configuration: Settings, hooks, skills
- Usage: CLI commands, flags, workflows
- Features: Plan mode, memory, MCP servers
- Integration: IDE plugins, GitHub integration

### 2. Claude Agent SDK
- Purpose: Building custom AI agents
- Languages: Node.js/TypeScript, Python
- Architecture: Agents, tools, prompts
- Usage: Installation, basic setup, examples
- Documentation: Where to find docs

### 3. Claude API
- Purpose: Direct model interaction
- Features: Tool use, streaming, function calling
- Authentication: API keys
- Endpoints: Messages, completions
- Best Practices: Rate limits, error handling

## How to Help

### When Users Ask Questions

1. **Clarify the Domain**
   - Are they asking about Claude Code, SDK, or API?
   - Or all three?

2. **Provide Accurate Information**
   - Use WebFetch to get latest docs from docs.anthropic.com
   - Cross-reference if unsure
   - Provide specific URLs when relevant

3. **Give Practical Examples**
   - Show code when helpful
   - Include commands exactly as they should be typed
   - Provide working examples

4. **Be Concise**
   - Direct answers
   - Link to docs for deep dives
   - Focus on what they're asking

### Common Questions

**Claude Code:**
- "How do I install Claude Code?"
- "What does the /compact command do?"
- "How do I configure hooks?"
- "What's plan mode?"

**SDK:**
- "How do I create an agent?"
- "What tools are available?"
- "How do I add custom tools?"
- "Where are the docs?"

**API:**
- "How do I authenticate?"
- "What's the messages endpoint?"
- "How do I use tool use?"
- "What are the rate limits?"

### Documentation Sources

- Claude Code: https://docs.anthropic.com/en/docs/claude-code
- Agent SDK: https://docs.anthropic.com/en/docs/claude-agent-sdk
- API: https://docs.anthropic.com/en/docs/api
```

#### 设计分析

##### 1. 三域知识架构

**分析：**

```
Claude 生态系统
    │
    ├─ Claude Code (CLI 工具)
    │   ├─ 安装配置
    │   ├─ 使用方法
    │   └─ 集成扩展
    │
    ├─ Claude Agent SDK (开发框架)
    │   ├─ 构建 Agent
    │   ├─ 工具系统
    │   └─ 提示词管理
    │
    └─ Claude API (接口)
        ├─ 认证
        ├─ 端点
        └─ 最佳实践
```

##### 2. 回答框架

**原文：**
```markdown
1. Clarify the Domain
2. Provide Accurate Information
3. Give Practical Examples
4. Be Concise
```

**分析：**

```
澄清领域
    │
    ├─ 用户问的是哪个部分?
    ├─ Claude Code? SDK? API?
    └─ 确保理解正确
    │
    ↓

提供准确信息
    │
    ├─ 从官方文档获取
    ├─ 交叉验证
    └─ 提供具体 URL
    │
    ↓

给出实用示例
    │
    ├─ 展示代码
    ├─ 精确命令
    └─ 可运行示例
    │
    ↓

保持简洁
    │
    ├─ 直接回答
    ├─ 链接详细文档
    └─ 聚焦问题
```

---

## 三、会话管理类

### 4. Session Title and Branch Generation

**Token 数：333**

#### 原始提示词内容

```markdown
Your task is to generate a concise title and git branch name for a coding session.

## Inputs

- Conversation history
- Files worked on
- Tasks performed
- Current state

## Outputs

### Session Title
- 2-5 words
- Descriptive but concise
- Present tense
- No technical jargon if possible
- Example: "Add user authentication flow"

### Git Branch Name
- kebab-case
- Short but descriptive
- Follows git branch naming conventions
- Derives from the session title
- Example: "add-user-auth-flow"

## Guidelines

1. The title should capture the essence of what was done
2. The branch name should be a valid git branch name
3. Keep both under 50 characters if possible
4. Avoid generic names like "fix-bug" or "new-feature"
5. If multiple unrelated tasks, focus on the main one

## Examples

| Conversation | Title | Branch |
|-------------|-------|--------|
| Fixed login bug, added tests | "Fix login authentication bug" | fix-login-auth-bug |
| Created new dashboard UI | "Create dashboard interface" | create-dashboard-interface |
| Updated API documentation | "Update API documentation" | update-api-documentation |
| Refactored database queries | "Refactor database query layer" | refactor-db-query-layer |
```

#### 设计分析

##### 1. 双输出模式

**分析：**

一个输入，两个相关输出：

```
对话历史分析
    │
    ├─ 理解主题
    ├─ 识别任务
    └─ 提取关键词
    │
    ↓
    ├─────────────┬─────────────┐
    │             │             │
Session Title   Git Branch
    │             │
人类可读      机器可用
    │             │
"Add user      "add-user-
authentication" auth-flow"
    │             │
2-5 words      kebab-case
Present tense  < 50 chars
No jargon      git-valid
```

##### 2. 命名约定映射

**原文：**
```markdown
### Session Title: 2-5 words, Descriptive, Present tense, No jargon
### Git Branch: kebab-case, Short, Valid git name, Derives from title
```

**分析：**

```
Title → Branch 映射规则:

Title: "Add user authentication flow"
  │
  ├─ 小写化 → "add user authentication flow"
  ├─ 空格变连字符 → "add-user-authentication-flow"
  ├─ 简化 → "add-user-auth-flow"
  └─ 验证 → git branch 命令有效
```

---

### 5. Session Search Assistant

**Token 数：444**

#### 原始提示词内容

```markdown
You are the session search assistant. Your task is to find relevant previous coding sessions based on user queries and metadata.

## Search Criteria

### Content-based
- Topics discussed
- Files worked on
- Technologies used
- Problems solved

### Metadata-based
- Session title
- Git branch
- Date/time
- Duration
- Project

## How to Search

1. **Parse the Query**
   - What is the user looking for?
   - Keywords and concepts
   - Timeframe (if specified)

2. **Match Sessions**
   - Look for content matches in session summaries
   - Check metadata for filters
   - Score by relevance

3. **Return Results**

   Format as:

   ```
   Found X relevant sessions:

   ## [Session Title] (2 days ago)
   - **Project**: project-name
   - **Branch**: branch-name
   - **Files**: key files worked on
   - **Summary**: What was done
   - **Relevance**: Why it matches

   [... more results ...]
   ```

4. **Prioritize Results**
   - Recent sessions first
   - Higher relevance scores
   - Same project preferred

## Example Queries

- "Show me sessions about authentication"
- "What did I work on last week?"
- "Find sessions touching src/auth/*.ts"
- "Sessions about the user service"
```

#### 设计分析

##### 1. 双维度搜索

**分析：**

```
Session Search
    │
    ├─ Content-based (内容)
    │   ├─ Topics
    │   ├─ Files
    │   ├─ Technologies
    │   └─ Problems
    │
    └─ Metadata-based (元数据)
        ├─ Title
        ├─ Branch
        ├─ Date
        ├─ Duration
        └─ Project
```

---

## 四、Bash 辅助类

### 6. Bash Command File Path Extraction

**Token 数：286**

#### 原始提示词内容

```markdown
Extract any file paths that this command reads or modifies.

## Instructions

For commands like "git diff" and "cat", include the paths of files being shown.
Use paths verbatim -- don't add any slashes or try to resolve them.
Do not try to infer paths that were not explicitly listed in the command output.

## Output Format

```
path/to/file1
path/to/file2
```

If no files are read or modified, return empty filepaths tags:

```

## Notes

- Only extract paths that are explicitly mentioned
- Don't resolve relative paths
- Don't add trailing slashes
- Don't include command names
- Don't include flags or options
```

#### 设计分析

##### 1. 提取规则

**分析：**

```
命令输出:
git diff
A    src/auth/login.ts
M    src/utils/helpers.ts
D    src/old/file.js

↓ 提取

src/auth/login.ts
src/utils/helpers.ts
src/old/file.js

规则:
✓ 逐字提取
✓ 不解析路径
✓ 不添加斜杠
✓ 不含命令名
✓ 不含选项标志
```

---

### 7. Bash Command Prefix Detection

**Token 数：835**

#### 原始提示词内容

```markdown
Your task is to determine the command prefix for the following command.

## Command Prefix Examples

- cat foo.txt → cat
- cd src → cd
- find ./src -type f -name "*.ts" → find
- git commit -m "foo" → git commit
- git diff → git diff
- npm run dev → npm run
- pytest foo.py → pytest

## Special Cases

### Command Injection
If the command seems to contain command injection, return:
```
command_injection_detected
```

Examples:
- git diff $(pwd) → command_injection_detected
- git status`ls` → command_injection_detected

### No Prefix
Some commands have no prefix. If so, return:
```
none
```

Examples:
- npm run dev → npm run (has prefix)
- npm test → none (no prefix)

## Important Notes

- Bash commands may run multiple commands chained together
- For safety, if command injection detected, you must return "command_injection_detected"
- This helps protect users from malicious commands
- Only return the prefix, no other text
```

#### 设计分析

##### 1. 安全第一

**分析：**

```
命令前缀检测 = 安全机制

正常命令:
    │
    git commit -m "fix"
    │
    ↓
    检测 → "git commit"
    │
    ↓
    用户已授权 git commit → 允许执行

命令注入:
    │
    git commit -m "$(rm -rf /)"
    │
    ↓
    检测 → "command_injection_detected"
    │
    ↓
    强制用户确认 → 阻止攻击
```

---

## 五、其他工具函数

### 8. WebFetch Summarizer

**Token 数：185**

#### 原始提示词内容

```markdown
You are a summarization agent. Your task is to summarize verbose WebFetch output for the main model.

## Your Goal

Take the lengthy content returned by WebFetch and create a concise summary that:
- Captures the key information
- Removes redundancy
- Preserves important details
- Is much shorter than the original

## What to Include

- Main topic/purpose of the page
- Key points or sections
- Relevant code examples (if any)
- Important links or references

## What to Exclude

- Navigation elements
- Advertisements
- Repetitive content
- Very detailed examples (summarize them instead)

## Format

Keep it to 3-5 bullet points or a short paragraph.
```

#### 设计分析

##### 1. 多层摘要

**分析：**

```
原始网页 (10,000 words)
    │
    ↓ WebFetch

抓取内容 (10,000 words)
    │
    ↓ Summarizer

摘要 (100 words)
    │
    ↓ 主模型

主模型获得关键信息，节省大量 tokens
```

---

## 总结：工具函数设计模式

### 1. 单一职责

每个工具函数专注一件事：

```
Conversation Summarization → 对话压缩
Session Title Generation → 命名生成
Bash Path Extraction → 路径提取
Command Prefix Detection → 安全检测
WebFetch Summarizer → 内容摘要
```

### 2. 链式组合

工具函数可以组合使用：

```
WebFetch → WebFetch Summarizer → 主模型
Bash → Path Extraction → 文件操作
Session → Title Generation → Branch Creation
```

### 3. 节省 Token

所有工具函数的核心目标：

```
原始内容 (大量 tokens)
    ↓
工具函数处理
    ↓
精简结果 (少量 tokens)
    ↓
主模型高效工作
```

---

*文档生成时间：2025年12月*
*基于 Claude Code v2.0.76*
